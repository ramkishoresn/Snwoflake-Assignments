CREATE OR REPLACE WAREHOUSE LOGS_WH
WITH
    WAREHOUSE_SIZE = 'XSMALL'
    AUTO_SUSPEND = 60
    AUTO_RESUME = TRUE;
USE WAREHOUSE LOGS_WH;

CREATE OR REPLACE DATABASE LOG_ANALYTICS_DB;
USE DATABASE LOG_ANALYTICS_DB;

CREATE OR REPLACE SCHEMA PUBLIC;
USE SCHEMA PUBLIC;

CREATE OR REPLACE TABLE APPLICATION_LOGS (
    EVENT_ID STRING,
    EVENT_TIME TIMESTAMP,
    SERVICE_NAME STRING,
    LOG_LEVEL STRING,
    USER_ID STRING,
    API_ENDPOINT STRING,
    RESPONSE_TIME_MS INTEGER,
    ERROR_MESSAGE STRING,
    REGION STRING,
    ERROR_FLAG INTEGER
);

SELECT * FROM APPLICATION_LOGS;
SELECT COUNT(*) FROM APPLICATION_LOGS;

SELECT SERVICE_NAME, COUNT(*) AS ERROR_COUNT
FROM APPLICATION_LOGS
WHERE ERROR_FLAG = 1
GROUP BY SERVICE_NAME;

SELECT SERVICE_NAME, AVG(RESPONSE_TIME_MS) AS AVG_RESPONSE_TIME
FROM APPLICATION_LOGS
GROUP BY SERVICE_NAME;

SELECT REGION, COUNT(*) AS ERROR_COUNT
FROM APPLICATION_LOGS
WHERE ERROR_FLAG = 1
GROUP BY REGION;
